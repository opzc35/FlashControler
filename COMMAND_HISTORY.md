# 命令历史功能说明

## 功能概述

FlashControler V1.0.3 新增了命令历史记忆功能，提供**三种方式**快速访问历史命令：
1. ⌨️ **上下箭头键** - 像Bash一样快速切换
2. 📜 **历史选择对话框** - 从列表中直接选择
3. 🔍 **可视化浏览** - 一目了然查看所有历史

## 使用方法

### 方式1: 上下箭头键（快速切换）

**↑ (上箭头键)**
- 向前浏览历史命令（从新到旧）
- 第一次按上箭头会显示最近执行的命令
- 继续按上箭头查看更早的命令

**↓ (下箭头键)**
- 向后浏览历史命令（从旧到新）
- 到达末尾后恢复到当前输入的内容

### 方式2: 历史选择对话框（可视化选择）

**打开方式：**
- 点击 **"📜 历史"** 按钮
- 或按快捷键 **Ctrl+H**

**使用步骤：**
1. 打开历史对话框
2. 从列表中浏览所有历史命令（最新的在上面）
3. 选择方式：
   - **双击**命令直接使用
   - 或**单击选中** + 点击"使用选中的命令"按钮
4. 命令自动填入输入框

**特点：**
- 📋 一次查看所有历史
- 🖱️ 鼠标操作更直观
- 🔍 可以快速浏览和对比
- ⚡ 双击即用，快速高效

### 使用示例

```
1. 执行命令：
   > ls
   > pwd
   > cd /tmp
   > ls -la

2. 按 ↑ 键浏览历史：
   第1次 ↑: 显示 "ls -la"
   第2次 ↑: 显示 "cd /tmp"
   第3次 ↑: 显示 "pwd"
   第4次 ↑: 显示 "ls"

3. 按 ↓ 键返回：
   第1次 ↓: 显示 "pwd"
   第2次 ↓: 显示 "cd /tmp"
   第3次 ↓: 显示 "ls -la"
   第4次 ↓: 清空输入框（回到当前状态）
```

## 功能特性

### 1. 自动保存
- 自动记录所有执行过的命令
- 最多保存100条历史记录
- 达到上限后自动删除最旧的命令

### 2. 智能去重
- **避免连续重复**：连续执行相同命令只记录一次
  ```
  > ls
  > ls    # 不会重复记录
  历史: [ls]
  ```

- **自动更新位置**：再次执行旧命令会将其移到最新
  ```
  执行顺序: ls → pwd → cd → ls
  历史: [pwd, cd, ls]  # 第二个ls替换了第一个
  ```

### 3. 临时输入保护
- 浏览历史时，当前输入的内容会被临时保存
- 按 ↓ 键到末尾后自动恢复

示例：
```
1. 输入: echo hel
2. 按 ↑ 浏览历史
3. 按 ↓ 返回末尾
4. 自动恢复: echo hel
```

### 4. 空命令过滤
- 空字符串不会加入历史
- 纯空格命令不会加入历史

## 实现细节

### PyQt5客户端

使用自定义 `CommandLineEdit` 类：
- 继承自 `QLineEdit`
- 重写 `keyPressEvent` 方法
- 处理 `Qt.Key_Up` 和 `Qt.Key_Down` 事件

### Tkinter客户端

使用事件绑定：
- 绑定 `<Up>` 和 `<Down>` 事件
- 在回调函数中处理历史浏览
- 返回 `"break"` 阻止默认行为

## 技术规格

| 属性 | 值 |
|------|-----|
| 最大历史记录数 | 100条 |
| 支持的客户端 | PyQt5, Tkinter |
| 内存占用 | 约 1-2 KB (100条命令) |
| 持久化 | 暂不支持（重启清空） |

## 常见问题

### Q1: 历史记录会保存到文件吗？
**A**: 目前不会。历史记录仅保存在内存中，关闭客户端后会清空。

未来版本计划添加持久化功能，将历史保存到：
- Windows: `%APPDATA%/FlashControler/history.txt`
- Linux: `~/.flashcontroler/history`

### Q2: 可以自定义历史记录数量吗？
**A**: 目前固定为100条。如需修改，可以编辑代码：

**PyQt5客户端** (`client_pyqt5.py:30`):
```python
self.max_history = 100  # 修改这个值
```

**Tkinter客户端** (`client.py:41`):
```python
self.max_history = 100  # 修改这个值
```

### Q3: 为什么连续执行相同命令不会重复记录？
**A**: 这是故意设计的。避免历史中充满重复命令，提高浏览效率。

如果需要查看命令执行了多少次，建议使用 `history` 命令（如果服务器支持）。

### Q4: 能搜索历史命令吗？
**A**: 目前不支持。未来版本计划添加：
- Ctrl+R 反向搜索
- 模糊匹配
- 关键词高亮

### Q5: 多个连接会共享历史吗？
**A**: 不会。每个客户端窗口有独立的历史记录。

## 快捷键总结

| 快捷键 | 功能 |
|--------|------|
| ↑ | 上一条历史命令 |
| ↓ | 下一条历史命令 |
| **Ctrl+H** | **打开历史选择对话框** |
| Enter | 执行命令并加入历史 |
| Esc | (未实现) 清空当前输入 |

## 三种方式对比

| 特性 | 上下箭头 | 历史对话框 |
|------|----------|------------|
| **速度** | ⚡⚡⚡ 最快 | ⚡⚡ 快速 |
| **便捷性** | 键盘操作 | 鼠标+键盘 |
| **可见性** | 单条查看 | 全部可见 |
| **适用场景** | 最近几条命令 | 查找历史命令 |
| **学习成本** | 低（习惯） | 低（直观） |

**推荐使用：**
- 🔄 **重复最近命令** → 使用 ↑ 箭头
- 📜 **查找历史命令** → 使用 Ctrl+H 打开对话框
- 🎯 **精确查找** → 使用对话框浏览所有历史

## 相关文档

- [FEATURES.md](FEATURES.md) - 完整功能列表
- [CHANGELOG.md](CHANGELOG.md) - V1.0.3更新日志
- [README.md](README.md) - 项目总览

## 测试

运行测试脚本验证功能：
```bash
python3 test_command_history.py
```

测试覆盖：
- ✓ 添加命令到历史
- ✓ 避免重复连续命令
- ✓ 向前浏览（上箭头）
- ✓ 向后浏览（下箭头）
- ✓ 命令去重
- ✓ 最大历史记录限制
- ✓ 空命令过滤

---

**版本**: V1.0.3
**更新日期**: 2024-11-28
